第十章:分布式系统 

第二天上午十点,沈柏寒的手机响了。

是一个陌生号码的来电。

他接起来:“喂?”

“请问是沈柏寒老师吗?“对方的声音年轻,带着一点紧张,“我是从Gear官网看到您的技术咨询服务的。我想预约一次咨询,方便吗?”

沈柏寒愣了一下。

昨天陆以辰在官网上挂出”专家咨询”链接的时候,他还觉得这只是个形式,不会真有人买账。

但现在,真的有人下单了。

“方便。“他说,“什么时候?”

“现在可以吗?“对方问,“我们团队遇到了一个很棘手的问题,实在是……如果您现在不方便,下午也可以。”

“现在可以。“沈柏寒站起来,走进书房,“你稍等,我准备一下。”

他打开电脑,登录腾讯会议,创建了一个会议室,把链接发给对方。

三分钟后,视频会议接通了。

对方没有开摄像头,沈柏寒也没开。两个人都只是语音。

“沈老师,我是EduTech的CTO,姓张。“对方说,“我们是一家在线教育公司,现在遇到了一个高并发下的架构瓶颈。”

“说说具体情况。“沈柏寒说,打开了白板工具。

“是这样的,我们的课程直播平台,在用户量超过两万的时候,会出现严重的延迟。有时候老师讲的话,学生这边要五六秒才能听到。”

“服务器配置?”

“阿里云ECS,16核32G内存,带宽100M。”

“数据库?”

“MySQL,主从复制。”

“缓存?”

“Redis,单机。”

沈柏寒听到”Redis单机”,心里就有数了。

“你们的Redis承载了什么数据?“他问。

“用户会话,课程信息,还有直播间的弹幕缓存。”

“弹幕?“沈柏寒抓住了关键词,“两万人的直播间,弹幕量是多少?”

“高峰期……每秒大概一千条。”

“那就是问题所在了。“沈柏寒在白板上画了一个架构图,“你们把弹幕这种高频写入的数据,和用户会话这种需要持久化的数据,放在同一个Redis里。这导致Redis的内存IO被弹幕占满了,用户会话的读写速度就变慢了。”

“再加上你们是单机Redis,没有做集群,所有的读写请求都压在一台机器上。两万用户的并发,单机Redis根本扛不住。”

电话那头沉默了几秒。

“天哪。“张总说,声音里带着恍然大悟的激动,“您说得太对了!我们一直在优化数据库,优化代码,但从来没想过是缓存策略的问题!”

“建议这样改。“沈柏寒继续画图,“第一,把Redis做集群,至少三节点。第二,把弹幕数据单独拆出来,用专门的消息队列处理,比如Kafka或RabbitMQ。第三,用户会话和课程信息继续放Redis,但要做好过期策略,别让内存溢出。”

“明白了,明白了!“张总说,“沈老师,您这个思路太清晰了!我们团队讨论了一周,都没找到问题所在,您三言两语就点破了!”

“这不难。“沈柏寒说,“就是基本的分布式架构原则——高频写入和低频读取要分离,不同类型的数据要用不同的存储方案。”

“是的,是的。“张总说,“沈老师,这次咨询太有价值了。我现在就转账给您。按照官网的价格,500一小时,我们聊了……40分钟,那就按一小时算。”

“不用,按实际时间算就好。“沈柏寒说。

“不行,您的建议值这个价。“张总说,“而且……我能再转您一个红包吗?作为感谢。您真的帮了我们大忙。”

“不用红包,按价格来就行。“沈柏寒说。

但对方坚持,最后还是转了800块——500的咨询费,加300的”感谢红包”。

挂断电话后,沈柏寒盯着手机屏幕上的到账通知,愣了很久。

800块。

40分钟。

他没有写一行代码,没有熬夜,没有透支身体。

他只是用脑子,用经验,用对架构的理解,就赚到了这笔钱。

而且,对方非常满意,甚至主动多付了钱。

他第一次真切地感受到——

原来,他不写代码,依然很有价值。

甚至,比写代码更有价值。

因为他解决的,是别人解决不了的问题。

他提供的,是别人买不到的经验。

这就是核心架构师的价值。

沈柏寒靠在椅背上,闭上眼睛,嘴角扬起了一个笑容。

晚上八点,沈柏寒的手机收到了一条GitHub通知。

“小宇(GearBoy)提交了一个Pull Request:#142 优化用户登录模块的验证逻辑”

沈柏寒点开通知,进入GitHub。

小宇的PR很正式,有标题,有描述,还附上了测试结果的截图。

“优化内容:

1. 将原有的正则表达式验证改为更高效的字符串方法
1. 增加了对特殊字符的过滤
1. 优化了错误提示信息的用户友好度

测试:已在本地环境测试通过,无Bug。

@沈柏寒 请审核。”

沈柏寒点开代码diff,看了看小宇的修改。

第一眼,他就看到了问题。

第45行,小宇用了一个嵌套的if-else逻辑,写了十几行。这段代码虽然能跑,但很冗余,可读性差。

第78行,小宇的错误提示写成了”输入不合法”,但没有说明哪里不合法,用户体验不好。

第102行,代码格式有问题,缩进不统一。

沈柏寒没有直接帮他改。

他在PR下面写了Review意见:

“总体思路正确,但有几个地方需要优化:

1. 第45-58行的逻辑过于冗余。建议用递归或者switch-case重构,减少嵌套层级。
1. 第78行的错误提示不够友好。建议明确告诉用户哪里出错了,比如’用户名不能包含特殊字符’而不是笼统地说’输入不合法’。
1. 代码格式问题:第102行缩进不统一,建议使用Prettier自动格式化。
1. 单元测试覆盖率不够。建议补充边界条件的测试用例,比如空字符串、超长字符串、纯特殊字符等。

修改后重新提交,我再审核。

PS: 这是你的第一个PR,整体完成度不错。继续加油!”

他点击”提交审核意见”。

几秒钟后,隔壁房间传来小宇的声音:

“收到!架构师!”

然后是一阵噼里啪啦的键盘声。

沈柏寒笑了。

十分钟后,小宇重新提交了代码。

这次,那些问题都修复了。

第45行的冗余逻辑,被改成了一个简洁的switch-case。

第78行的错误提示,变成了具体的、友好的描述。

代码格式,整整齐齐。

单元测试,也补充了五个边界条件的用例。

沈柏寒仔细看完,点击了”Approve”。

“Review通过。可以合并到主分支。做得很好!”

几秒钟后,小宇冲进书房,兴奋地举着手机:

“爸爸!我的第一个PR被批准了!”

“嗯,不错。“沈柏寒说,“但记住,代码质量永远比速度重要。不要为了快而牺牲质量。”

“知道了!“小宇说,“那我继续去写下一个功能?”

“去吧。“沈柏寒说,“记得写完先自己Review一遍,再提交。”

“收到!”

小宇跑回房间,继续敲代码。

沈柏寒看着小宇的背影,心里涌起一股复杂的情绪。

他在教小宇写代码。

但他没有手把手地教,没有坐在旁边盯着,没有一行一行地帮他改。

他只是指路,提建议,做审核。

这种”非接触式”的协作,让他感到一种前所未有的轻松和满足。

他不需要透支身体,不需要熬夜,不需要亲自动手。

他只需要用脑子,用经验,用判断力。

这就是分布式系统的好处。

任务被分解了,压力被分摊了。

他不再是那个扛着所有流量的单点服务器。

他是架构师,是决策者,是这个系统的核心节点。

而小宇,是执行者。

社区的志愿者们,也是执行者。

他们共同构成了一个分布式网络。

即使他这个主节点慢下来,网络依然在高效运行。

第二天上午,沈柏寒打开GitHub,看到Gear的仓库炸了。

Star数量,从两天前的8500,涨到了12000。

Fork数量,从1200涨到了3500。

Issues列表里,原本那68个未处理的问题,现在只剩下15个——其他的都被社区的志愿者们认领并解决了。

Pull Request列表里,有37个新的提交,等待审核。

Discussion区,热度最高的帖子是陆以辰发布的”招募志愿者”。

沈柏寒点进去,看到了上百条回复:

“我是大厂程序员,白天写KPI代码写吐了,晚上想来Gear写点有意义的。已认领Issue #52。”

“我不是程序员,但我是特教老师。看到Gear的教育理念,很感动。我可以帮忙做用户测试和教学文档翻译。”

“Gear的AGPL协议太酷了!这才是真正的开源精神。我来贡献代码了!”

“沈老师,您的设计哲学深深打动了我。我想跟着您学习架构设计。”

“Gear改变了我儿子的学习方式。作为家长,我想尽一份力。我会前端,可以帮忙优化界面。”

沈柏寒一条一条地看,眼眶渐渐红了。

他一直以为,Gear只是他一个人的项目。

但现在,它已经变成了一个社区,一个网络,一个由无数个陌生人共同维护的系统。

这些人,有大厂程序员,有在校学生,有特教老师,有全职家长。

他们来自不同的背景,有不同的技能,但他们都因为Gear的理念聚在一起。

他们不要钱,不要名,只是想做点”有意义的事”。

沈柏寒突然明白了什么。

这就是开源的力量。

这就是分布式系统的魅力。

即使他这个创始人倒下了,Gear也不会死。

因为它已经不属于他一个人了。

它属于所有相信”代码可以是诗”的人。

属于所有相信”教育可以改变命运”的人。

属于所有愿意用自己的时间和精力,让这个世界变得更好一点的人。

他点开那37个Pull Request,开始一个一个审核。

有些代码写得很好,他直接批准。

有些代码有问题,他写下详细的Review意见,让对方修改。

有些代码的思路不对,他耐心解释为什么不应该这样做,并给出替代方案。

三个小时后,37个PR变成了10个。

27个被批准并合并了。

沈柏寒靠在椅背上,感觉很满足。

他没有写一行代码。

但Gear的功能增加了,Bug减少了,代码质量提高了。

这就是分布式系统。

这就是他作为架构师的价值。

他不需要做所有的事。

他只需要做对的决策。

下午三点,沈柏寒正在喝陆以辰泡的护肝茶,手机收到了一封邮件通知。

发件人:Gear官方邮箱。

他打开邮箱,看到了一封新邮件。

主题:“关于Gear案例中的那个孩子”

发件人:一个陌生的邮箱地址,ID是”L.Y.2018”。

沈柏寒皱起眉头,点开邮件。

“您好,

我是从Gear的官网看到您们的教学案例的。其中有一个案例,提到了一个叫’小宇’的孩子,说他是通过Gear学习编程,并且在很短的时间内就展现了惊人的天赋。

我想请问,这个案例是真实的吗?

如果是真实的,那个孩子……是不是左手手背上有一块胎记?形状像一只小鸟?

如果是,能否告诉我怎么联系他的家长?

我有很重要的事情需要和他们谈。

谢谢。

L.Y.”

沈柏寒盯着这封邮件,手开始颤抖。

左手手背上的胎记。

形状像一只小鸟。

小宇确实有这个胎记。

这是他们领养小宇时,福利院提供的特征信息之一。

而现在,有人通过Gear的官网,找到了这个线索。

沈柏寒的心脏狂跳起来。

这个”L.Y.“是谁?

为什么知道小宇的胎记?

为什么想联系小宇的家长?

沈柏寒的脑海里,浮现出一个他一直不愿意去想的可能性——

生母。

小宇的生母。

那个八年前把还是婴儿的小宇留在福利院门口的女人。

她找来了。

沈柏寒盯着邮件,感觉刚刚建立起的安全感,瞬间裂开了一道缝。

他知道,这一天迟早会来。

他知道,血缘关系是一个无法回避的问题。

但他以为,这一天还很远。

他以为,他还有时间准备。

但现在,它来了。

在他刚刚适应新生活,刚刚找到新定位,刚刚开始相信”一切都会好起来”的时候。

它来了。

沈柏寒的手指悬在键盘上方,不知道该不该回复。

如果回复,该怎么说?

承认小宇是他们的孩子?

还是装作不知道?

如果不回复,这个人会怎么做?

会放弃?

还是会继续追查?

会不会直接找到家里来?

沈柏寒闭上眼睛,深吸一口气。

他想叫陆以辰过来,和他一起面对这件事。

但陆以辰还在学校上课,要晚上才回来。

小宇还在房间里写代码,开开心心的,完全不知道有人在找他。

沈柏寒盯着那封邮件,感觉一种巨大的恐惧从心底涌起。

不是对那个陌生人的恐惧。

是对”失去”的恐惧。

如果小宇的生母找来了,要求见小宇,该怎么办?

如果她要求把小宇带回去,该怎么办?

如果小宇知道了真相,知道他有一个”真正的”妈妈,会怎么想?

他还会叫他”爸爸”吗?

他还会觉得这个家是他的家吗?

沈柏寒的手紧紧攥着手机,指节发白。

窗外,上海的阳光很好。

客厅里,小宇的笑声传来——他应该是在和同学视频聊天,聊着学校里的趣事。

一切都那么美好,那么和平。

但沈柏寒知道,这只是暴风雨前的宁静。

那道裂缝,已经出现了。

而他不知道,当它彻底撕裂的时候,这个刚刚修复好的家,还能不能撑得住。

他盯着邮件,最终还是没有回复。

他把邮件标记为”未读”,关掉了手机。

他需要时间思考。

他需要和陆以辰商量。

但在那之前,他要保护好这个家,保护好小宇,保护好他们刚刚建立起的、脆弱的、但温暖的日常。

即使,这个日常,可能很快就会被打破。​​​​​​​​​​​​​​​​